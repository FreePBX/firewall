#!/usr/bin/env php
<?php
// vim: :set filetype=php tabstop=4 shiftwidth=4 autoindent smartindent:

// Development:  Make sure we're not running as root.  This would be
// a vulnerability if it is, as we're not doing integrity checks on
// files here (we don't need to!)

if (posix_geteuid() === 0) {
	// throw new \Exception("I was run as root");
}

// Fast BMO instantiation
$bootstrap_settings['freepbx_auth'] = false;
$bootstrap_settings['skip_astman'] = true;
// $bootstrap_settings['whoops_handler'] = 'JsonResponseHandler';
$restrict_mods = true;
include '/etc/freepbx.conf';

// Start with our known information from FreePBX
$services = array ("smartports" => \FreePBX::Firewall()->getSmartPorts(), "fw" => array(), "services" => array());

// Figure out where all the services we're caring about are.
$knownsvcs = \FreePBX::Firewall()->getServices();
foreach ($knownsvcs as $section) {
	foreach ($section as $k) {
		$s = \FreePBX::Firewall()->getService($k);
		if (isset($s['fw'])) {
			$services['fw'][$k] = $s['fw'];
		}
		$services['services'][$k] = $s;
	}
}

// print_r($services); exit;
print json_encode($services)."\n";


